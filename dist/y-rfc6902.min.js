(function(p,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports,require("yjs")):"function"===typeof define&&define.amd?define(["exports","yjs"],r):(p="undefined"!==typeof globalThis?globalThis:p||self,r(p["y-rfc6902"]={},p.Y))})(this,function(p,r){function I(a){return a.replace(/~1/g,"/").replace(/~0/g,"~")}function J(a){return a.replace(/~/g,"~0").replace(/\//g,"~1")}function D(a){return void 0===a?"undefined":null===a?"null":Array.isArray(a)?"array":typeof a}function y(a){if(null==
a||"object"!=typeof a)return a;if(a.constructor==Array){var b=a.length,c=Array(b);for(let d=0;d<b;d++)c[d]=y(a[d]);return c}b={};for(c in a)w.call(a,c)&&(b[c]=y(a[c]));return b}function x(a){switch(typeof a){case "string":case "number":case "boolean":return a;case "object":if(Array.isArray(a)){const c=new m.Array;c.push(a.map(x));return c}if(null===a)return null;const b=new m.Map;Object.entries(a).forEach(([c,d])=>{b.set(c,x(d))});return b}}function z(a){if(!(a instanceof m.AbstractType))return y(a);
if(a instanceof m.Array){const b=a.length,c=Array(b);for(let d=0;d<b;d++)c[d]=z(a.get(d));return c}if(a instanceof m.Map)return a=Array.from(a.entries()),new m.Map(a);console.log("cannot serialize type",a);throw Error("cannot serialize type");}function K(a,b=0,c=0,d=[]){a instanceof m.Array?(c&&a.delete(b,c),d&&a.insert(b,d)):a.splice(b,c,...d)}function L(a){return a.replace(/~1/g,"/").replace(/~0/g,"~")}function M(a){return a.replace(/~/g,"~0").replace(/\//g,"~1")}function N({op:a}){return"remove"===
a||"replace"===a||"copy"===a||"move"===a}function E(a,b){const c={};for(const d in a)w.call(a,d)&&void 0!==a[d]&&(c[d]=1);for(const d in b)w.call(b,d)&&void 0!==b[d]&&delete c[d];return Object.keys(c)}function O(a){const b=a.length,c={};for(let d=0;d<b;d++){const e=a[d];for(const f in e)w.call(e,f)&&void 0!==e[f]&&(c[f]=(c[f]||0)+1)}for(const d in c)c[d]<b&&delete c[d];return Object.keys(c)}function A(a,b){return{operations:a.operations.concat(b),cost:a.cost+1}}function P(a,b,c,d=t){function e(k,
g){const h=`${k},${g}`;var l=f[h];if(void 0===l){if(0<k&&0<g&&!d(a[k-1],b[g-1],new B).length)l=e(k-1,g-1);else{l=[];if(0<k){var u=e(k-1,g);l.push(A(u,{op:"remove",index:k-1}))}0<g&&(u=e(k,g-1),l.push(A(u,{op:"add",index:k-1,value:b[g-1]})));0<k&&0<g&&(u=e(k-1,g-1),l.push(A(u,{op:"replace",index:k-1,original:a[k-1],value:b[g-1]})));l=l.sort((Q,R)=>Q.cost-R.cost)[0]}f[h]=l}return l}const f={"0,0":{operations:[],cost:0}},F=isNaN(a.length)||0>=a.length?0:a.length;var v=isNaN(b.length)||0>=b.length?0:
b.length;v=e(F,v).operations;[v]=v.reduce(([k,g],h)=>{if("add"===h.op){var l=h.index+1+g;h={op:h.op,path:c.add(l<F+g?String(l):"-").toString(),value:h.value};return[k.concat(h),g+1]}if("remove"===h.op)return h={op:h.op,path:c.add(String(h.index+g)).toString()},[k.concat(h),g-1];l=c.add(String(h.index+g));h=d(h.original,h.value,l);return[k.concat(...h),g]},[[],0]);return v}function S(a,b,c,d=t){const e=[];E(a,b).forEach(f=>{e.push({op:"remove",path:c.add(f).toString()})});E(b,a).forEach(f=>{e.push({op:"add",
path:c.add(f).toString(),value:b[f]})});O([a,b]).forEach(f=>{e.push(...d(a[f],b[f],c.add(f)))});return e}function t(a,b,c,d=t){if(a===b)return[];const e=D(a),f=D(b);return"array"==e&&"array"==f?P(a,b,c,d):"object"==e&&"object"==f?S(a,b,c,d):[{op:"replace",path:c.toString(),value:b}]}function C(a,b,c){a instanceof m.AbstractType?a instanceof m.Map?a.set(b,c):a instanceof m.Array&&a.insert(parseInt(b),[c]):Array.isArray(a)?"-"==b?a.push(c):(b=parseInt(b,10),a.splice(b,0,c)):a[b]=c}function G(a,b){Array.isArray(a)||
a instanceof m.Array?(b=parseInt(b,10),K(a,b,1)):delete a[b]}function T(a,b,c=!0){a=n.fromJSON(b.path).evaluate(a);if(void 0===a.parent)return new q(b.path);b=c?z(b.value):b.value;C(a.parent,a.key,b);return null}function U(a,b){var c=n.fromJSON(b.path).evaluate(a);if(null===c.parent)return new q(b.path);if(Array.isArray(c.parent)){if(parseInt(c.key,10)>=c.parent.length)return new q(b.path)}else if(void 0===c.value)return new q(b.path);a=c.parent;b=b.value;c=c.key;const d=x(b);a instanceof m.Map?a.set(c,
d):a instanceof m.Array?a.insert(c||a.length,[d]):a[c]=b;return null}function V(a,b,c){switch(b.op){case "add":return T(a,b,c);case "remove":return a=n.fromJSON(b.path).evaluate(a),void 0===a.value?b=new q(b.path):(G(a.parent,a.key),b=null),b;case "replace":return U(a,b);case "move":return c=n.fromJSON(b.from).evaluate(a),void 0===c.value?b=new q(b.from):(a=n.fromJSON(b.path).evaluate(a),void 0===a.parent?b=new q(b.path):(G(c.parent,c.key),C(a.parent,a.key,c.value),b=null)),b;case "copy":return c=
n.fromJSON(b.from).evaluate(a),void 0===c.value?b=new q(b.from):(a=n.fromJSON(b.path).evaluate(a),void 0===a.parent?b=new q(b.path):(C(a.parent,a.key,z(c.value)),b=null)),b;case "test":return a=n.fromJSON(b.path).evaluate(a),a=a.value&&a.value.toJSON?a.value.toJSON():a.value,b=t(a,b.value,new n).length?new W(a,b.value):null,b}return new X(b)}function Y(a){function b(c,d,e){const f=a(c,d,e);return Array.isArray(f)?f:t(c,d,e,b)}return b}function H(a,b){var c=new r.Doc;a=x(a);c.getMap("test").set("item",
a);c=n.fromJSON(b).evaluate(a);a=c.value&&c.value.toJSON?c.value.toJSON():c.value;if(void 0!==c)return{op:"test",path:b,value:a}}var m=function(a){if(a&&a.__esModule)return a;var b=Object.create(null);a&&Object.keys(a).forEach(function(c){if("default"!==c){var d=Object.getOwnPropertyDescriptor(a,c);Object.defineProperty(b,c,d.get?d:{enumerable:!0,get:function(){return a[c]}})}});b["default"]=a;return Object.freeze(b)}(r);class n{constructor(a=[""]){this.tokens=a}static fromJSON(a){const b=a.split("/").map(I);
if(""!==b[0])throw Error(`Invalid JSON Pointer: ${a}`);return new n(b)}toString(){return this.tokens.map(J).join("/")}evaluate(a){let b=null,c="";for(let d=1,e=this.tokens.length;d<e;d++)b=a,c=this.tokens[d],a=b instanceof r.Map||b instanceof r.Array?b&&b.get(c):(b||{})[c];return{parent:b,key:c,value:a}}get(a){return this.evaluate(a).value}set(a,b){for(let c=1,d=this.tokens.length-1,e=this.tokens[c];c<d;c++)a=(a||{})[e];a&&(a[this.tokens[this.tokens.length-1]]=b)}push(a){this.tokens.push(a)}add(a){a=
this.tokens.concat(String(a));return new n(a)}}const w=Object.prototype.hasOwnProperty;class B{constructor(a=[""]){this.tokens=a}static fromJSON(a){const b=a.split("/").map(L);if(""!==b[0])throw Error(`Invalid JSON Pointer: ${a}`);return new B(b)}toString(){return this.tokens.map(M).join("/")}evaluate(a){let b=null,c="";for(let d=1,e=this.tokens.length;d<e;d++)b=a,c=this.tokens[d],a=(b||{})[c];return{parent:b,key:c,value:a}}get(a){return this.evaluate(a).value}set(a,b){for(let c=1,d=this.tokens.length-
1,e=this.tokens[c];c<d;c++)a=(a||{})[e];a&&(a[this.tokens[this.tokens.length-1]]=b)}push(a){this.tokens.push(a)}add(a){a=this.tokens.concat(String(a));return new B(a)}}class q extends Error{constructor(a){super(`Value required at path: ${a}`);this.path=a;this.name="MissingError"}}class W extends Error{constructor(a,b){super(`Test failed: ${a} != ${b}`);this.actual=a;this.expected=b;this.name="TestError"}}class X extends Error{constructor(a){super(`Invalid operation: ${a.op}`);this.operation=a;this.name=
"InvalidOperationError"}}p.applyPatch=function(a,b,c){return b.map(d=>V(a,d,c))};p.createPatch=function(a,b,c){const d=new n;return(c?Y(c):t)(a,b,d)};p.createYTests=function(a,b){const c=[];b.filter(N).forEach(d=>{const e=H(a,d.path);e&&c.push(e);"from"in d&&(d=H(a,d.from))&&c.push(d)});return c};Object.defineProperty(p,"__esModule",{value:!0})});
